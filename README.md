# The _not yet_ ultimate guide to BRIL Inner Tracker Simulations

### Preface
This guide is intended for people working on the BRIL Phase II upgrade, more specifically simulations of the Inner Tracker for Lumi measurements. It gives detailed instructions on how to set up and run simulations with custom IT geometries and varying levels of pileup. It is sectioned in the following parts:

1. setting up an appropriate CMSSW Environment
1. using custom geometry files exported from [TkLayout] (http://tklayout.web.cern.ch)
1. generating Minimum Bias Events using the custom geometry to use as Pileup input for the rest of the simulation
1. running the full simulation
    * locally for a small data sample using the runTheMatrix.py command of CMSSW
    * locally using the runSim.sh script that wraps the above for more convenience
    * on the HT Condor batch system using the runSim.sh script and a submission file
1. runnig the BRIL ITclusterAnalyzer on the output EDM file to populate BRIL relevant histograms for further analysis

### Setting up an Environment
It is preferrable to run these steps on a machine with access to the CERN cvmfs read-only filesystem as this allows to use different CMSSW releases -- this usually means lxplus. Before you get started, make sure that you have a few GB of available space in the directory you want to run in. This could either be /afs or /eos. The release this guide is based on is `CMSSW_10_4_0_pre2` that you set up like so:

```
source $VO_CMS_SW_DIR/cmsset_default.sh
mkdir mySimDir
cd mySimDir
cmsrel CMSSW_10_4_0_pre2
cd CMSSW_10_4_0_pre2/src/
```

This creates a CMSSW working area in the directory mySimDir/ where a directory tree is created in the CMSSW_10_4_0_pre2/ folder. All your code and packages are always going to the `/src` subdirecory - it is the only place where you will be working.

```
cmsenv
```

This sets up the working environment, the paths and the right compiler. In the next step we need to check out some packages from the CMSSW github repo that we want to modify. Specifically, these will contain the modified geometry files. 

```
git cms-addpkg Configuration/PyReleaseValidation
git cms-addpkg Geometry/TrackerCommonData
git cms-addpkg Geometry/TrackerRecoData
git cms-addpkg Geometry/TrackerSimData
git cms-addpkg SLHCUpgradeSimulations/Geometry
```

### Using custom Geometries
Once done with the previous step, you have to get the custom geometry files and put the in the appropriate place. First, you have to check out this repo in your CMSSW work area, so `mySimDir/CMSSW_10_4_0_pre2/src`.

```
cd mySimDir/CMSSW_10_4_0_pre2/src
git clone https://github.com/gauzinge/BRIL_ITsim.git
cd BRIL_ITsim
```

or better yet clone the repo to your github account! Now you can call the `copyGeo.sh` with the following arguments: `-s mysourceDir -d mydestDir` to copy all relevant geometry files from the source (most likely `BRIL_ITsim/ITGeometries/OT614_200_IT612` in this repo as source and `mySimDir/CMSSW_10_4_0_pre2/src` as destination). 

```
source copyGeo.sh -s ITGeometries/OT614_200_IT612 -d mySimDir/CMSSW_10_4_0_pre2/src
```

The next step is crucial, so pay attention: since you modified the geometry files you have to re-build your added CMSSW sources. This is done using the scram command

```
scram b -j8
```

for 8 core compilation. Now everything you do will be based on the custom geometry.

### Generating Minimum Bias Events to use as Pileup Input in the actual Simulation

The next step is to generate a large enough sample of Minimum Bias events for your scenario that can later be used as Pileup input for the actual simulation. To do this, you need to run the first step of the workflow generated by the CMS `runTheMatrix.py` command. It is important to choose the right scenario which in our case is the Phase II upgrade. The name is *2023D21*.

```
runTheMatrix.py €”what upgrade -l 21240 -ne
```

will just dump the commands to your terminal but I suggest running the actual cmsDriver command instead:

```
cmsDriver.py MinBias_14TeV_pythia8_TuneCUETP8M1_cfi  --conditions auto:phase2_realistic -n 2000 --era Phase2 --eventcontent FEVTDEBUG --relval 90000,100 -s GEN,SIM --datatier GEN-SIM --beamspot HLLHC14TeV --geometry Extended2023D21 --nThreads 4
```

this generates 2000 Minimum Bias Events in a file calles ` MinBias_14TeV_pythia8_TuneCUETP8M1_cfi_GEN_SIM.root` -- put it somewhere where you won't accidentially delete it:

```
cd mySimDir/CMSSW_10_4_0_pre2/src
mkdir myMinBiasSample
mv  MinBias_14TeV_pythia8_TuneCUETP8M1_cfi_GEN_SIM.* myMinBiasSample/
```

Congratulations, you are almost done! In order to use these events you have to edit a file in `mySimDir/CMSSW_10_4_0_pre2/src/Configuration/PyReleaseValidation/python/relval_steps.py`:
the easiest is to search for the string _PUData_ in your editor. Then edit these lines:

```
PUDataSets={}
for ds in defaultDataSets:
    key='MinBias_14TeV_pythia8_TuneCUETP8M1'+'_'+ds
    name=baseDataSetReleaseBetter[key]
#    if '2017' in name or '2018' in name:
    if '2017' in name:
    	PUDataSets[ds]={'-n':10,'--pileup':'AVE_35_BX_25ns','--pileup_input':'das:/RelValMinBias_13/%s/GEN-SIM'%(name,)}
    elif '2018' in name:
    	PUDataSets[ds]={'-n':10,'--pileup':'AVE_50_BX_25ns','--pileup_input':'das:/RelValMinBias_13/%s/GEN-SIM'%(name,)}
    else:
        PUDataSets[ds]={'-n':10,'--pileup':'AVE_35_BX_25ns','--pileup_input':'das:/RelValMinBias_14TeV/%s/GEN-SIM'%(name,)}
```

change the last line to:

```
        PUDataSets[ds]={'-n':10,'--pileup':'AVE_35_BX_25ns','--pileup_input':'file:mySimDir/CMSSW_10_4_0_pre2/src/myMinBiasSample/MinBias_14TeV_pythia8_TuneCUETP8M1_cfi_GEN_SIM.root'}
```

this will tell CMSSW to use your Minimum Bias Data sample as Pileup input instead of some files with a standard geometry from the database. This is really important. Next, you have to once more compile your work environment to make it pick up the changes:

```
scram b -j8
```

Congratulations, you are all set for running the actual simulation!

### Running the full Simulation
There are 3 possible ways to run the full simulation. The normal way using the `runTheMatrix.py` command, a wrapper script called `runSim.sh` that is part of this repo or in batch mode on the CERN HT Condor batch service. The details will be described in the following sections!

#### RunTheMatrix


